<style>
    .main-item{
        margin-bottom: 5px;
    }
    .teamShowBox{
        background-color: #FFFFFF;
        border: 1px solid #C0C4CC;
        position: absolute;
        top: 100%;
        left: 0px;
        right: 0px;
        min-height: 26px;
        max-height: 150px;
        overflow-y: auto;

    }
    .teamShowBox li{
        padding-left: 8px;
        height: 25px;
        line-height: 25px;
        background-color: #f0f0f0;
        border-bottom: 1px solid #FFFFFF;
    }
    .teamShowBox li:last-child{
        border-bottom: 0px;
    }

</style>
<div class="layui-form" lay-filter="layuiadmin-app-form-list" id="layuiadmin-app-form-list" style="margin:3px;padding:20px;background-color: #fff;">
    <div style="height:25px;"></div>
    <div class="layui-container">
        <div class="layui-row layui-col-space15">
            <div class="layui-col-sm9 layui-col-xs9">
                <fieldset class="layui-elem-field box-top">
                    <legend>分类信息 <font color="#ccc"></font></legend>
                    <div class="layui-field-box">
                        <div class="layui-row">
                            <div class="layui-form-item">
                                <label class="layui-form-label">所属分类</label>
                                <div class="layui-input-block">
                                    <select name="category_id" xm-select="select1" xm-select-show-count="3">
                                        {$data['category_list']|raw}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>
                <fieldset class="layui-elem-field box-top">
                    <legend>基本信息 <font color="#ccc"></font></legend>
                    <div class="layui-field-box">
                        <div class="layui-row">
                            <div class="layui-form-item">
                                <label class="layui-form-label">文章标题</label>
                                <div class="layui-input-block">
                                    <input type="text" name="title" lay-verify="required" autocomplete="off" placeholder="请输入文章标题" class="layui-input" value="{$data['title']}">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">作者</label>
                                <div class="layui-input-block" style="max-width:150px;">
                                    <input type="text" name="author" lay-verify="" autocomplete="off" placeholder="请输入作者" class="layui-input" value="{$data['author']}">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">关键词</label>
                                <div class="layui-input-block">
                                    <input type="text" name="keywords" autocomplete="off" placeholder="请输入SEO关键词" class="layui-input" value="{$data['keywords']}">
                                    <p class="layui-word-aux">多关键词之间用英文逗号隔开</p>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">来源媒体</label>
                                <div class="layui-input-block" style="max-width: 150px;">
                                    <input type="text" name="source_name" autocomplete="off" placeholder="请输入来源媒体名称" class="layui-input" value="{$data['source_name']}">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">来源地址</label>
                                <div class="layui-input-block">
                                    <input type="text" name="source_url" autocomplete="off" placeholder="请输入文章来源地址" class="layui-input" value="{$data['source_url']}">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">文章摘要</label>
                                <div class="layui-input-block">
                                    <textarea name="description" placeholder="请输入文章摘要" class="layui-textarea">{$data['description']}</textarea>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <input type="checkbox" name="matche_status" lay-skin="switch" lay-filter="matche" value="1" lay-text="开启赛事|关闭赛事" {$data['matche_status']?'checked':''}>
                            </div>
                            <div class="layui-form-item" id="matche-box" style="display: {$data['matche_status']?'block':'none'};">
                                <fieldset class="layui-elem-field box-top">
                                    <legend>赛事信息 <font color="#ccc"></font></legend>
                                    <div class="layui-field-box">
                                        <div class="layui-row">
                                            <div class="layui-form-item">
                                                <label class="layui-form-label"></label>
                                                <div class="layui-form-block">
                                                    <div class="layui-input-inline" style="width: 70px;">
                                                        <select name="matche_type">
                                                            <option value="0" {$data['matche_type']?'':'selected'}>足球</option>
                                                            <option value="1" {$data['matche_type']?'selected':''}>蓝球</option>
                                                        </select>
                                                    </div>
                                                    <div class="layui-input-inline" style="width: 80px;">
                                                        <input type="text" name="league_name" value="{$data['league_name']}" placeholder="联赛名称" class="layui-input">
                                                    </div>
                                                    <div class="layui-input-inline" style="width: 150px;">
                                                        <input type="text" name="open_time" value="{$data['open_time']}" placeholder="开赛时间" class="layui-input">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="layui-form-item">
                                                <label class="layui-form-label"></label>
                                                <div class="layui-form-block" style="display: flex; align-items: center;">
                                                    <div>
                                                        <div style="text-align: center;">
                                                            <img src="{$data['main_image_url']?$data['main_image_url']:'/static/admin/style/images/default-thumbnail.png'}" style="width:100px; height:100px;" class="teamAddImage">
                                                            <input type="hidden" name="team[0][image_url]" value="{$data['main_image_url']}" class="image_value">
                                                            <input type="hidden" name="team[0][id]" value="{$data['main_id']}" class="id_value">
                                                        </div>
                                                        <div style="height: 25px; font-size: 12px; line-height: 25px; text-align: center;">主队</div>
                                                        <div style="position: relative;">
                                                            <input type="text" name="team[0][name]" value="{$data['main_name']}" placeholder="请输入队名" class="layui-input teamNamechange" style="padding-left: 0px;text-align: center;">
                                                            <div class="teamShowBox" style="display: none;">
                                                                <ul>

                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div style="width: 100px; font-size: 36px; text-align: center;">vs</div>
                                                    <div>
                                                        <div style="text-align: center;">
                                                            <img src="{$data['passenger_image_url']?$data['passenger_image_url']:'/static/admin/style/images/default-thumbnail.png'}" style="width:100px; height:100px;" class="teamAddImage">
                                                            <input type="hidden" name="team[1][image_url]" value="{$data['passenger_image_url']}" class="image_value">
                                                            <input type="hidden" name="team[1][id]" value="{$data['passenger_id']}" class="id_value">
                                                        </div>
                                                        <div style="height: 25px; font-size: 12px; line-height: 25px; text-align: center;">客队</div>
                                                        <div style="position: relative;">
                                                            <input type="text" name="team[1][name]" value="{$data['passenger_name']}" placeholder="请输入队名" class="layui-input teamNamechange" style="padding-left: 0px;text-align: center;">
                                                            <div class="teamShowBox" style="display: none;">
                                                                <ul>

                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                            <div id="main-box">
                                                {if !$data['attr_data']}
                                                <div class="layui-form-item main-item">
                                                    <label class="layui-form-label"></label>
                                                    <div class="layui-form-block" style="display: flex; justify-content: flex-start;">
                                                        <div>
                                                            <input type="text" name="attr[0][main][value]" placeholder="胜平负" class="layui-input" style="padding-left: 0px;text-align: center;">
                                                            <input type="hidden" name="attr[0][main][color]" value="#333333" class="color-value">
                                                        </div>
                                                        <div style="margin-left: 35px;">
                                                            <input type="text" name="attr[0][param][0][value]" placeholder="胜" class="layui-input" style="padding-left: 0px;text-align: center;">
                                                            <input type="hidden" name="attr[0][param][0][color]" value="#333333" class="color-value">
                                                        </div>
                                                        <div>
                                                            <input type="text" name="attr[0][param][1][value]" placeholder="平" class="layui-input" style="padding-left: 0px;text-align: center;">
                                                            <input type="hidden" name="attr[0][param][1][color]" value="#333333" class="color-value">
                                                        </div>
                                                        <div style="margin-right: 15px;">
                                                            <input type="text" name="attr[0][param][2][value]" placeholder="负" class="layui-input" style="padding-left: 0px;text-align: center;">
                                                            <input type="hidden" name="attr[0][param][2][color]" value="#333333" class="color-value">
                                                        </div>
                                                        <div style="text-align: left; margin-right: 30px;">
                                                            <a href="javascript: void(0);" class="delMainItem" style="margin-top: 5px;color: #dd0000;background-color: #f0f0f0;display: inline-block;width:20px;height:20px;line-height:20px;text-align: center;"> - </a>
                                                        </div>
                                                    </div>
                                                </div>
                                                {/if}
                                                {volist name="data['attr_data']" id="vl"}
                                                    <div class="layui-form-item main-item">
                                                        <label class="layui-form-label"></label>
                                                        <div class="layui-form-block" style="display: flex; justify-content: flex-start;">
                                                            <div>
                                                                <input type="text" name="attr[{$key}][main][value]" value="{$vl['main']['value']}" placeholder="胜平负" class="layui-input" style="padding-left: 0px;text-align: center;color:{$vl['main']['color']};">
                                                                <input type="hidden" name="attr[{$key}][main][color]" value="{$vl['main']['color']}" class="color-value">
                                                            </div>
                                                            <div style="margin-left: 35px;">
                                                                <input type="text" name="attr[{$key}][param][0][value]" value="{$vl['param'][0]['value']}" placeholder="胜" class="layui-input" style="padding-left: 0px;text-align: center;color:{$vl['param'][0]['color']};">
                                                                <input type="hidden" name="attr[{$key}][param][0][color]" value="{$vl['param'][0]['color']}" class="color-value">
                                                            </div>
                                                            <div>
                                                                <input type="text" name="attr[{$key}][param][1][value]" value="{$vl['param'][1]['value']}" placeholder="平" class="layui-input" style="padding-left: 0px;text-align: center;color:{$vl['param'][1]['color']};">
                                                                <input type="hidden" name="attr[{$key}][param][1][color]" value="{$vl['param'][1]['color']}" class="color-value">
                                                            </div>
                                                            <div style="margin-right: 15px;">
                                                                <input type="text" name="attr[{$key}][param][2][value]" value="{$vl['param'][2]['value']}" placeholder="负" class="layui-input" style="padding-left: 0px;text-align: center;color:{$vl['param'][2]['color']};">
                                                                <input type="hidden" name="attr[{$key}][param][2][color]" value="{$vl['param'][2]['color']}" class="color-value">
                                                            </div>
                                                            <div style="text-align: left; margin-right: 30px;">
                                                                <a href="javascript: void(0);" class="delMainItem" style="margin-top: 5px;color: #dd0000;background-color: #f0f0f0;display: inline-block;width:20px;height:20px;line-height:20px;text-align: center;"> - </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {/volist}
                                            </div>
                                            <div class="layui-form-item" id="main-end">
                                                <label class="layui-form-label"></label>
                                                <div class="layui-form-block" style="display: flex; justify-content: space-between;">
                                                    <div>
                                                        <a href="javascript:void(0);" id="addMainItem" style="display: inline-block; width:20px; height:20px; text-align: center;background-color: #C0C4CC;"> + </a>
                                                    </div>
                                                    <div class="color-btn">
                                                        <a href="javascript:void(0);" data-value="#4DAF29" style="display: inline-block; width:20px; height:20px; background-color: #4DAF29"></a>
                                                        <a href="javascript:void(0);" data-value="#dd0000" style="display: inline-block; width:20px; height:20px; background-color: #dd0000"></a>
                                                        <a href="javascript:void(0);" data-value="#333333" style="display: inline-block; width:20px; height:20px; background-color: #3F3F3F"></a>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>



                        </div>
                    </div>
                </fieldset>

                <fieldset class="layui-elem-field box-top">
                    <legend>文章内容 <font color="#ccc"></font></legend>
                    <div class="layui-field-box">
                        <div class="layui-row">
                            <div class="layui-form-item">
                                <textarea name="content" id="content" placeholder="请输入文章内容" style="width: 100%; height: 400px;">
                                    {$data['content']|raw}
                                </textarea>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </div>
            <div class="layui-col-sm3 layui-col-xs3">
                <fieldset class="layui-elem-field sm">
                    <legend>缩略图 <font color="#ccc"></font></legend>
                    <div class="layui-field-box sm">
                        <div class="layui-row">
                            <div class="layui-form-item" style="text-align: center;">
                                <img src="{$data['image_url']|default='/static/admin/style/images/default-thumbnail.png'}" id="upload-thumbnail" data-type="thumb" width="80%">
                                <input type="hidden" name="image_url" value="{$data['image_url']}" class="image_value">
                            </div>
                        </div>
                    </div>
                </fieldset>
                <fieldset class="layui-elem-field sm">
                    <legend>发布时间 <font color="#ccc"></font></legend>
                    <div class="layui-field-box">
                        <div class="layui-row">
                            <div class="layui-form-item">
                                <input type="text" name="published_time" class="layui-input" placeholder="发布时间" value="{:date('Y-m-d H:i:s', $data['published_time'])}">
                            </div>
                        </div>
                    </div>
                </fieldset>
                <fieldset class="layui-elem-field sm">
                    <legend>定时任务 <font color="#ccc"></font></legend>
                    <div class="layui-field-box">
                        <div class="layui-row">
                            <div class="layui-form-item">
                                <input type="checkbox" name="task" value="1" title="定时" lay-skin="primary" lay-filter="task" {$data['task']?'checked':''}>
                            </div>
                        </div>
                    </div>
                </fieldset>
                <fieldset class="layui-elem-field sm">
                    <legend>发布状态 <font color="#ccc"></font></legend>
                    <div class="layui-field-box">
                        <div class="layui-row">
                            <div class="layui-form-item">
                                <input type="checkbox" name="status" value="1" title="发布" lay-skin="primary" lay-filter="status" {$data['status']?'checked':''}>
                            </div>
                            <div class="layui-form-item">
                                <input type="checkbox" name="hot" value="1" title="热门" lay-skin="primary" {$data['hot']?'checked':''}>
                            </div>
                            <!--<div class="layui-form-item">-->
                                <!--<input type="checkbox" name="top" value="1" title="置顶" lay-skin="primary" {$data['top']?'checked':''}>-->
                            <!--</div>-->
                            <div class="layui-form-item">
                                <input type="checkbox" name="recommended" value="1" title="推荐" lay-skin="primary" {$data['recommended']?'checked':''}>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="layui-elem-field sm">
                    <legend>设置评论 <font color="#ccc"></font></legend>
                    <div class="layui-field-box">
                        <div class="layui-row">
                            <div class="layui-form-item">
                                <input type="radio" name="comment_status" value="1" title="允许评论" {$data['comment_status']==1?'checked':''}>
                            </div>
                            <div class="layui-form-item">
                                <input type="radio" name="comment_status" value="0" title="不许评论" {$data['comment_status']==0?'checked':''}>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>
        <div class="layui-form-item layui-hide">
            <input type="hidden" name="id" value="{$data['id']}">
            <button class="layui-btn" lay-submit="" id="layuiadmin-app-form-submit" lay-filter="layuiadmin-app-form-submit">立即提交</button>
            <button id="getContent">设置编辑器内容</button>
        </div>
    </div>


    <script src="__EXTEND__/ueditors/ueditor.config.js?v=1.9.6"></script>
    <script src="__EXTEND__/ueditors/ueditor.all.min.js?v=1.9.6"></script>
    <script>
        bodyD.use(['index','form','laydate','upload','formSelects'], function () {
            var $ = layui.$,
                form = layui.form,
                laydate = layui.laydate,
                upload = layui.upload,
                admin = layui.admin,
                formSelects = layui.formSelects;

            //分类下拉
            formSelects.btns('select1', ['select', 'remove'], {show: 'name'});
            //发布时间
            laydate.render({
                elem: 'input[name="published_time"]',
                type: 'datetime',
            });

            //开赛时间
            laydate.render({
                elem: 'input[name="open_time"]',
                type: 'datetime',
            });
            //上传缩略图
            uploadImages($('#upload-thumbnail'), '{:url("PortalNews/uploadImage",["type"=>"__type__"])}');
            //上传taem图
            uploadImages($('.teamAddImage'), '{:url("PortalNews/uploadTeamImage")}');
            //关联历史taem
            $(".teamNamechange").on('keyup', function () {
                var teamName = $(this).val();
                var teamShowBox = $(this).siblings('.teamShowBox');
                if(teamName){
                    var teamType = $('select[name="matche_type"]').val();
                    console.log(teamType);
                    teamShowBox.find('ul').html('');
                    admin.req({
                        url:  '{:url("PortalNews/team")}',
                        data: {'name': teamName, 'type': teamType},
                        type: 'Get',
                        done: function (res) {

                            if(res.data.length){
                                $.each(res.data, function (i, n) {
                                    teamShowBox.find('ul').append('<li data-id="'+ n.id +'" data-name="'+ n.name +'" data-image="'+ n.image_url +'">'+ n.name +'</li>');
                                })
                                teamShowBox.show();
                            }else{
                                teamShowBox.hide();
                            }

                        }
                    });

                }else{
                    teamShowBox.hide();
                }
            }).on('focusout', function () {
                var that = $(this).siblings('.teamShowBox');
                setTimeout(function () {
                    that.hide();
                }, 500);
            }).on('focusin', function () {
                if($(this).siblings('.teamShowBox li').length){
                    $(this).siblings('.teamShowBox').show();
                }
            });

            $('.teamShowBox').on('click', 'li', function () {
                var oThat = $(this);
                var oInputBox = oThat.parent().parent().parent().parent();

                oThat.parent().parent().parent().find('input.teamNamechange').val(oThat.data('name'));
                oInputBox.find('input.image_value').val(oThat.data('image'));
                oInputBox.find('input.id_value').val(oThat.data('id'));
                oInputBox.find('img').attr('src', oThat.data('image'));
            });

            //监听定时任务
            form.on('checkbox(task)', function(data){
                if(data.elem.checked){
                    $("input[name=\"status\"]").prop("checked", false);
                    form.render();
                }
            });
            form.on('checkbox(status)', function(data){
                if(data.elem.checked){
                    $("input[name=\"task\"]").prop("checked", false);
                    form.render();
                }
            });
            //监听盘口开关
            form.on('switch(matche)', function(data){
                var matcheBox = $("#matche-box");
                if(data.elem.checked){
                    matcheBox.show();
                    return false;
                }
                matcheBox.hide();
            });
            //增加 盘口
            $("#addMainItem").on('click', function () {
                // console.log('@@@');
                var mainItem = $("#main-box .layui-form-item.main-item").first();
                var mainCount = $("#main-box .layui-form-item.main-item").length;
                console.log('###:'+mainCount);
                $("#main-box").append(mainItem.clone());
                var itemLast = $("#main-box .layui-form-item.main-item").last();

                itemLast.find('input').each(function () {
                    var that = $(this);
                    var thatName = that.attr('name');
                    var newName = thatName.replace('attr[0]', 'attr[' + mainCount + ']');
                    that.attr('name', newName).val('').css({'color': '#333333'});

                });
                itemLast.find('input[type="hidden"]').val('#3F3F3F');

            });
            //删除 盘口
            $("#main-box").on('click', 'a.delMainItem', function () {
                if($("#main-box .layui-form-item.main-item").length == 1){
                    return false;
                }
                var that = $(this).parent().parent().parent();
                that.remove();

                $("#main-box .main-item").each(function (i,n) {
                    var that = $(this).find('input');
                    var firstName = that.attr('name');
                    //console.log(firstName);
                    var numIndex = firstName.match(/\d+(\d+)?/)[0];
                    //console.log(numIndex);
                    that.each(function () {
                        var thatName = $(this).attr('name');
                        //console.log(thatName);
                        $(this).attr('name', thatName.replace('attr['+numIndex+']', 'attr['+i+']'));
                    })
                });

            });
            var inputFocus = '';
            //绑定事件
            $("#main-box").on('focusin', 'input', function () {
                inputFocus = $(this);
                //console.log('focusin');
            });
            //设置颜色
            $("#main-end .color-btn a").on('click', function () {
                //console.log('@@@@@');
                var oColor = $(this).data('value');
                if(inputFocus.length){
                    //console.log('1');
                    inputFocus.css({'color': oColor});
                    inputFocus.siblings('input[type="hidden"]').val(oColor);
                    return false;
                }
                //console.log('0');
            });

            //监听定时任务
            form.on('checkbox(task)', function(data){
                if(data.elem.checked){
                    $("input[name=\"status\"]").prop('checked', false);
                    form.render();
                }
            });
            form.on('checkbox(status)', function(data){
                if(data.elem.checked){
                    $("input[name=\"task\"]").prop("checked", false);
                    form.render();
                }
            });

            var ue = UE.getEditor('content', {
                serverUrl: "{:url('PortalNews/upDetailsImages',['type'=>'content'])}",
                enableAutoSave: false,
                saveInterval: 1000 * 3600,
                enableContextMenu: false,
                autoHeightEnabled: false,
            });

            $("#getContent").click('click', function () {
                //console.log(ue.getContent());
                $('textarea[name="content"]').val(ue.getContent());
            });

            //上传图
            function uploadImages(uploadName, oUrl, label) {
                var type = uploadName.data('type');
                //var oUrl = '{:url("PortalNews/uploadImage",["type"=>"__type__"])}';
                //上传头像
                upload.render({
                    elem: uploadName
                    , url: oUrl.replace('__type__', type)
                    , accept: 'file' //普通文件
                    , exts: 'jpg|jpeg|png|gif' //只允许上传压缩文件
                    , before: function (obj) { //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
                        layer.load(); //上传loading
                    }
                    , done: function (res) {
                        layer.closeAll('loading');
                        var item = this.item;
                        if(res.code == 0) {
                            //console.log(label);
                            if (label == undefined) {
                                item.attr('src', res.data.file);
                                item.siblings('input.image_value').val(res.data.file);
                                item.siblings('input.id_value').val('0');
                            }
                            return false;
                        }
                        layer.msg(res.msg, {icon:0});
                    }
                    , error: function () {
                        layer.msg('上传错误！', {icon: 0});
                    }
                });
            }
        });
    </script>